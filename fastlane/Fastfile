default_platform(:ios)

# ============================================
# iOS
# ============================================
platform :ios do
  desc "Build and upload iOS to Firebase App Distribution"
  lane :distribute do
    # Setup CI environment
    setup_ci if is_ci

    # Fetch certificates using Match
    match(
      type: "adhoc",
      readonly: is_ci,
      git_basic_authorization: Base64.strict_encode64(ENV["MATCH_GIT_BASIC_AUTH"]),
      clone_branch_directly: true
    )

    # Build Flutter app with production flavor
    Dir.chdir("..") do
      dart_defines = ""
      dart_defines += " --dart-define=GOOGLE_PLACES_API_KEY=#{ENV['GOOGLE_PLACES_API_KEY']}" if ENV['GOOGLE_PLACES_API_KEY']
      sh("flutter build ios --release --flavor production --no-codesign -t lib/main_production.dart#{dart_defines}")
    end

    # Configure code signing for manual signing
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/Runner.xcodeproj",
      team_id: "S2NBGK85WD",
      profile_name: "match AdHoc com.tekadept.randoeats",
      code_sign_identity: "Apple Distribution",
      targets: ["Runner"]
    )

    # Build and sign IPA
    build_app(
      workspace: "ios/Runner.xcworkspace",
      scheme: "production",
      configuration: "Release-production",
      export_method: "ad-hoc",
      output_directory: "build/ios",
      output_name: "RandoEats.ipa",
      export_options: {
        provisioningProfiles: {
          "com.tekadept.randoeats" => "match AdHoc com.tekadept.randoeats"
        }
      }
    )

    # Upload to Firebase App Distribution
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID_IOS"],
      release_notes: changelog_from_git_commits(commits_count: 5, merge_commit_filtering: "exclude_merges"),
      service_credentials_file: ENV["GOOGLE_SERVICE_ACCOUNT_KEY_PATH"]
    )
  end

  desc "Sync certificates (run locally first time)"
  lane :sync_certs do
    match(type: "adhoc")
  end
end

# ============================================
# Android
# ============================================
platform :android do
  desc "Build and upload Android to Firebase App Distribution"
  lane :distribute do
    # Build Flutter app with production flavor
    Dir.chdir("..") do
      dart_defines = ""
      dart_defines += " --dart-define=GOOGLE_PLACES_API_KEY=#{ENV['GOOGLE_PLACES_API_KEY']}" if ENV['GOOGLE_PLACES_API_KEY']
      sh("flutter build apk --release --flavor production -t lib/main_production.dart#{dart_defines}")
    end

    # Upload to Firebase App Distribution
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID_ANDROID"],
      release_notes: changelog_from_git_commits(commits_count: 5, merge_commit_filtering: "exclude_merges"),
      android_artifact_type: "APK",
      android_artifact_path: "build/app/outputs/flutter-apk/app-production-release.apk",
      service_credentials_file: ENV["GOOGLE_SERVICE_ACCOUNT_KEY_PATH"]
    )
  end
end

# ============================================
# Both Platforms
# ============================================
desc "Build and distribute both platforms"
lane :distribute_all do
  Fastlane::LaneManager.cruise_lane("ios", "distribute")
  Fastlane::LaneManager.cruise_lane("android", "distribute")
end
