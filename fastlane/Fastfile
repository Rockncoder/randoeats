default_platform(:ios)

# ============================================
# iOS
# ============================================
platform :ios do
  desc "Build and upload iOS to Firebase App Distribution"
  lane :distribute do
    # Setup CI environment
    setup_ci if is_ci

    # Fetch certificates using Match
    match(
      type: "adhoc",
      readonly: is_ci,
      git_private_key: ENV["MATCH_GIT_PRIVATE_KEY"],
      clone_branch_directly: true
    )

    # Build Flutter app with production flavor
    Dir.chdir("..") do
      dart_defines = ""
      dart_defines += " --dart-define=GOOGLE_PLACES_API_KEY=#{ENV['GOOGLE_PLACES_API_KEY']}" if ENV['GOOGLE_PLACES_API_KEY']
      sh("flutter build ios --release --flavor production --no-codesign -t lib/main_production.dart#{dart_defines}")
    end

    # Configure code signing for manual signing
    update_code_signing_settings(
      use_automatic_signing: false,
      path: "ios/Runner.xcodeproj",
      team_id: "S2NBGK85WD",
      profile_name: "match AdHoc com.tekadept.randoeats",
      code_sign_identity: "Apple Distribution",
      targets: ["Runner"]
    )

    # Build and sign IPA
    build_app(
      workspace: "ios/Runner.xcworkspace",
      scheme: "production",
      configuration: "Release-production",
      export_method: "ad-hoc",
      output_directory: "build/ios",
      output_name: "RandoEats.ipa",
      export_options: {
        provisioningProfiles: {
          "com.tekadept.randoeats" => "match AdHoc com.tekadept.randoeats"
        }
      }
    )

    # Upload to Firebase App Distribution
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID_IOS"],
      groups: "testers",
      release_notes: changelog_from_git_commits(commits_count: 5, merge_commit_filtering: "exclude_merges"),
      service_credentials_file: ENV["GOOGLE_SERVICE_ACCOUNT_KEY_PATH"]
    )
  end

  desc "Sync certificates (run locally first time)"
  lane :sync_certs do
    match(type: "adhoc")
  end
end

# ============================================
# Android
# ============================================
platform :android do
  desc "Build and upload Android to Firebase App Distribution"
  lane :distribute do
    # Build Flutter app with production flavor
    Dir.chdir("..") do
      dart_defines = ""
      dart_defines += " --dart-define=GOOGLE_PLACES_API_KEY=#{ENV['GOOGLE_PLACES_API_KEY']}" if ENV['GOOGLE_PLACES_API_KEY']
      sh("flutter build apk --release --flavor production -t lib/main_production.dart#{dart_defines}")
    end

    # Upload to Firebase App Distribution
    firebase_app_distribution(
      app: ENV["FIREBASE_APP_ID_ANDROID"],
      groups: "testers",
      release_notes: changelog_from_git_commits(commits_count: 5, merge_commit_filtering: "exclude_merges"),
      android_artifact_type: "APK",
      android_artifact_path: "build/app/outputs/flutter-apk/app-production-release.apk",
      service_credentials_file: ENV["GOOGLE_SERVICE_ACCOUNT_KEY_PATH"]
    )
  end
end

# ============================================
# Both Platforms
# ============================================
desc "Build and distribute both platforms"
lane :distribute_all do
  Fastlane::LaneManager.cruise_lane("ios", "distribute")
  Fastlane::LaneManager.cruise_lane("android", "distribute")
end

# ============================================
# Screenshots (Integration Tests on iOS Simulators)
# ============================================
desc "Generate App Store screenshots via integration tests on iOS simulators"
lane :screenshots do
  sh("mkdir -p fastlane/screenshots/en-US")

  target = "integration_test/screenshot_test.dart"
  tmp_dir = "/tmp/flutter_screenshots"

  # --- iPhone ---
  iphone_udid = `xcrun simctl list devices available | grep "iPhone 16 Pro Max" | head -1`.match(/\(([A-F0-9-]+)\)/)[1]
  UI.message("Capturing iPhone screenshots on #{iphone_udid}...")

  sh("xcrun simctl boot #{iphone_udid} 2>/dev/null || true")
  sh("rm -rf #{tmp_dir}")
  Dir.chdir("..") do
    sh("flutter test #{target} --flavor production -d #{iphone_udid}")
  end
  sh("xcrun simctl shutdown #{iphone_udid} 2>/dev/null || true")

  Dir.glob("#{tmp_dir}/*.png").each do |src|
    name = File.basename(src, ".png")
    FileUtils.cp(src, "../fastlane/screenshots/en-US/#{name}_iphone.png")
  end

  # --- iPad ---
  ipad_udid = `xcrun simctl list devices available | grep "iPad Pro 13-inch (M4)" | head -1`.match(/\(([A-F0-9-]+)\)/)[1]
  UI.message("Capturing iPad screenshots on #{ipad_udid}...")

  sh("xcrun simctl boot #{ipad_udid} 2>/dev/null || true")
  sh("rm -rf #{tmp_dir}")
  Dir.chdir("..") do
    sh("flutter test #{target} --flavor production -d #{ipad_udid}")
  end
  sh("xcrun simctl shutdown #{ipad_udid} 2>/dev/null || true")

  Dir.glob("#{tmp_dir}/*.png").each do |src|
    name = File.basename(src, ".png")
    FileUtils.cp(src, "../fastlane/screenshots/en-US/#{name}_ipad.png")
  end

  UI.success("Screenshots generated in fastlane/screenshots/en-US/")
end
